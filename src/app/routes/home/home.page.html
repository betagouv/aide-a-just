@if (openSuggestionPanel === false) {
  <div id="toolbar" class="toolbar">
    @for (card of docTools; track card.title) {
      <div>
        <img [src]="card.image" alt="a-just" (click)="goToLink(card.url)" />
        <p (click)="goToLink(card.url)">{{ card.title }}</p>
        @if (card.download) {
          <i (click)="goToLink(card.url, true)" class="ri-file-download-line"></i>
        }
      </div>
    }
  </div>

  <div class="section-one">
    <div class="title-area">
      <img src="/assets/images/community.svg" alt="a-just" />

      @if (!environment.isCA) {
        <p class="sub-title">Saisissez votre question ci-dessous</p>
        <div class="research-area"></div>
        <aj-input-button
          #searchInput
          class="full-width"
          placeholder="Que recherchez vous ?"
          (valueChange)="searchValue = $event; lockPrompt = false"
          [ngModel]="searchValue"
          (search)="onSearchBy()"
          ngDefaultControl
          icon=""
          (focusin)="focusOn = true"
          (focusout)="delay()"
          (keydown.enter)="onKeyDown()"
        >
          @if (displayLoader) {
            <div class="loader"></div>
          }
          <div
            class="validate-prompt"
            (click)="onSearchBy(); lockPrompt = true; displayResult = true; this.data = null"
          >
            <i
              class="ri-arrow-right-circle-fill"
              [ngStyle]="{ color: searchValue.length > 0 && !lockPrompt ? '#3a3a3a' : 'lightgray' }"
            ></i>
          </div>
        </aj-input-button>
      }
    </div>
    <div class="line"></div>
    <div class="action-area">
      <div class="clickable-link" (click)="goToLink(userGuide.url)">
        <img [src]="userGuide.image" alt="a-just" />
        <p class="title">{{ userGuide.title }}</p>
      </div>
      <div class="clickable-link" (click)="goToLink(dataBook.url)">
        <img [src]="dataBook.image" alt="a-just" />
        <p class="title">{{ dataBook.title }}</p>
      </div>
      <a routerLink="/call" class="blue">
        <img src="/assets/images/call-center.png" alt="a-just" />
        <p class="title">Être recontacté</p>
      </a>
    </div>
  </div>

  @if (displayResult === true && data !== null) {
    <div class="result-area">
      @if (data?.answer) {
        <div class="gitbook-response">
          <i
            class="ri-close-line close-tab"
            (click)="displayResult = false; data = null; searchInput.value = ''; searchValue = ''"
          ></i>
          @if (!data.answer.answer) {
            <p>Aucun résultat trouvé</p>
          }

          <!-- Réponse Principale -->
          @if (data.answer.answer?.document?.nodes) {
            <div>
              <h2>Réponse</h2>
              <ng-container *ngFor="let node of data.answer.answer.document.nodes">
                @if (node.type === 'paragraph' || node.type === 'text') {
                  <p>
                    @for (textNode of node.nodes; track textNode.leaves) {
                      @for (leaf of textNode.leaves; track leaf.text) {
                        <span [ngClass]="{ bold: isBold(leaf), italic: isItalic(leaf), underline: isUnderline(leaf) }">
                          {{ leaf.text }}
                        </span>
                      }

                      @if (textNode.type === 'link') {
                        @for (links of textNode.nodes; track links.leaves) {
                          @for (leaf of links.leaves; track leaf.text) {
                            <a
                              target="_blank"
                              [href]="textNode?.data?.ref?.url"
                              [ngClass]="{ bold: isBold(leaf), italic: isItalic(leaf), underline: isUnderline(leaf) }"
                            >
                              {{ leaf.text }}
                            </a>
                          }
                        }
                      }
                    }
                  </p>
                }

                <ul *ngIf="node.type === 'list-unordered'">
                  <li *ngFor="let item of node.nodes">
                    <ng-container *ngFor="let itemList of item.nodes">
                      <p *ngIf="itemList.type === 'paragraph'">
                        <ng-container *ngFor="let textNode of itemList.nodes">
                          <ng-container *ngFor="let leaf of textNode.leaves">
                            <span class="ordered-list-title" [ngClass]="{ bold: isBold(leaf) }">{{ leaf.text }}</span>
                          </ng-container>

                          <ng-container *ngIf="textNode.type === 'link'">
                            <ng-container *ngFor="let links of textNode.nodes">
                              <ng-container *ngFor="let leaf of links.leaves">
                                <a
                                  target="_blank"
                                  [href]="textNode?.data?.ref?.url"
                                  [ngClass]="{
                                    bold: isBold(leaf),
                                    italic: isItalic(leaf),
                                    underline: isUnderline(leaf),
                                  }"
                                >
                                  {{ leaf.text }}
                                </a>
                              </ng-container>
                            </ng-container>
                          </ng-container>
                        </ng-container>
                      </p>
                      <ng-container *ngIf="itemList.type === 'link'">
                        <ng-container *ngFor="let links of itemList.nodes">
                          <ng-container *ngFor="let leaf of links.leaves">
                            <a
                              target="_blank"
                              href="{{ itemList.data.ref.url }}"
                              [ngClass]="{ bold: isBold(leaf), italic: isItalic(leaf), underline: isUnderline(leaf) }"
                            >
                              {{ leaf.text }}
                            </a>
                          </ng-container>
                        </ng-container>
                      </ng-container>

                      <ng-container *ngIf="itemList.type === 'list-unordered'">
                        <ng-container *ngFor="let subItemList of itemList.nodes">
                          <ng-container *ngFor="let subNodes of subItemList.nodes">
                            <ng-container *ngFor="let textNode of subNodes.nodes">
                              <ng-container *ngFor="let leaf of textNode.leaves">
                                <span [ngClass]="{ bold: isBold(leaf) }">{{ leaf.text }}</span>
                              </ng-container>
                            </ng-container>
                          </ng-container>

                          <ng-container *ngIf="subItemList.type === 'link'">
                            <ng-container *ngFor="let links of subItemList.nodes">
                              <ng-container *ngFor="let leaf of links.leaves">
                                <a
                                  target="_blank"
                                  href="{{ subItemList.data.ref.url }}"
                                  [ngClass]="{
                                    bold: isBold(leaf),
                                    italic: isItalic(leaf),
                                    underline: isUnderline(leaf),
                                  }"
                                >
                                  {{ leaf.text }}
                                </a>
                              </ng-container>
                            </ng-container>
                          </ng-container>
                        </ng-container>
                      </ng-container>
                    </ng-container>

                    <ng-container *ngFor="let textNode of item.nodes">
                      <ng-container *ngFor="let leaf of textNode.leaves">
                        <ng-container *ngIf="leaf.text">{{ leaf.text }}</ng-container>
                      </ng-container>

                      <ng-container *ngIf="textNode.type === 'link'">
                        <ng-container *ngFor="let links of textNode.nodes">
                          <ng-container *ngFor="let leaf of links.leaves">
                            <a
                              target="_blank"
                              [href]="textNode?.data?.ref?.url"
                              [ngClass]="{ bold: isBold(leaf), italic: isItalic(leaf), underline: isUnderline(leaf) }"
                            >
                              {{ leaf.text }}
                            </a>
                          </ng-container>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                  </li>
                </ul>
                <!---->

                @if (node.type === 'list-ordered') {
                  <ol>
                    @for (item of node.nodes; track item.nodes) {
                      <li>
                        @for (itemList of item.nodes; track itemList.nodes) {
                          @if (itemList.type === 'paragraph') {
                            <p>
                              @for (textNode of itemList.nodes; track textNode.leaves) {
                                @for (leaf of textNode.leaves; track leaf.text) {
                                  <span class="ordered-list-title" [ngClass]="{ bold: isBold(leaf) }">
                                    {{ leaf.text }}
                                  </span>
                                }
                              }
                            </p>
                          }
                          @if (itemList.type === 'link') {
                            @for (links of itemList.nodes; track links.leaves) {
                              @for (leaf of links.leaves; track leaf.text) {
                                <a
                                  target="_blank"
                                  [href]="itemList?.data?.ref?.url"
                                  [ngClass]="{
                                    bold: isBold(leaf),
                                    italic: isItalic(leaf),
                                    underline: isUnderline(leaf),
                                  }"
                                >
                                  {{ leaf.text }}
                                </a>
                              }
                            }
                          }

                          @if (itemList.type === 'list-unordered') {
                            @for (subItemList of itemList.nodes; track subItemList.nodes) {
                              @for (subNodes of subItemList.nodes; track subNodes.nodes) {
                                @for (textNode of subNodes.nodes; track textNode.leaves) {
                                  @for (leaf of textNode.leaves; track leaf.text) {
                                    <span [ngClass]="{ bold: isBold(leaf) }">{{ leaf.text }}</span>
                                  }
                                }
                              }
                            }
                          }
                        }
                      </li>
                    }
                  </ol>
                }

                @if (node.type === 'heading-1') {
                  <h1>{{ node.nodes[0]?.nodes[0]?.leaves[0]?.text }}</h1>
                }
                @if (node.type === 'heading-2') {
                  <h2>{{ node.nodes[0]?.nodes[0]?.leaves[0]?.text }}</h2>
                }
                @if (node.type === 'heading-3') {
                  <h3>{{ node.nodes[0]?.nodes[0]?.leaves[0]?.text }}</h3>
                }

                @if (node.type === 'quote') {
                  <blockquote>
                    @for (textNode of node.nodes; track textNode.leaves) {
                      @for (leaf of textNode.leaves; track leaf.text) {
                        <p>{{ leaf.text }}</p>
                      }
                    }
                  </blockquote>
                }

                <pre *ngIf="node.type === 'code'">
                            <code>
                                <ng-container *ngFor="let textNode of node.nodes">
                                    <ng-container *ngFor="let text of textNode.nodes">
                                        <ng-container *ngFor="let leaf of text.leaves">
                                            {{ leaf.text }}
                                        </ng-container>                                  
                                  </ng-container>
                                </ng-container>
                            </code>
                        </pre>
              </ng-container>
            </div>
          }

          <!-- Questions de Suivi -->
          @if (data.answer.followupQuestions?.length) {
            <div class="separator">
              <h2>Questions liées</h2>
              <ng-container *ngFor="let question of data.answer.followupQuestions">
                <p
                  class="following"
                  (click)="
                    searchValue = question;
                    displayResult = true;
                    data = null;
                    onSearchBy();
                    onSearchBy();
                    lockPrompt = true;
                    scrollTo('toolbar');
                    searchInput.value = question
                  "
                >
                  <i class="ri-arrow-right-line"></i>
                  {{ question }}
                </p>
              </ng-container>
            </div>
          }

          <!-- Sources -->
          @if (data.answer.sources?.length) {
            <div class="source-container">
              <h2>Sources</h2>
              On peut remplir cette section et récupérer les sources utilisées (sections dans gitbook) pour la rédaction
              de la réponse, mais je vous laisse voir déjà si ce prototype vous plait et si vous souhaitez qu'on
              approfondisse.
            </div>
          }
        </div>
      }
    </div>
  }

  @if (environment.isTJ) {
    <p class="sub-title">Questions fréquentes</p>
    <div class="suggestion">
      <div (click)="openToIframe = documentation[0]; reloadContent()">
        <label>
          <span class="blue">Tout savoir</span>
          <br />
          <span class="blue">en un coup d’oeil</span>
          <br />
          <p class="italic">Les questions que tout le monde se pose</p>
        </label>
        <br />
        <mat-icon>arrow_forward</mat-icon>
      </div>
      <div (click)="openToIframe = documentation[1]; reloadContent()">
        <label>
          <span class="green">Prenez en main</span>
          <br />
          <span class="green">votre espace</span>
          <br />
          <p class="italic">Gérez vos effectifs et vos données d’activité</p>
        </label>
        <br />
        <mat-icon>arrow_forward</mat-icon>
      </div>
      <div (click)="openToIframe = documentation[2]; reloadContent()">
        <label>
          <span class="red">Pilotez votre juridiction</span>
          <br />
          <p class="italic">
            Simulez une trajectoire ou des affectations,
            <br />
            exploitez vos données et indicateurs
          </p>
        </label>
        <br />
        <mat-icon>arrow_forward</mat-icon>
      </div>
      <div (click)="openToIframe = documentation[3]; reloadContent()">
        <label>
          <span class="yellow">Cas d'usage</span>
          <br />
          <p class="italic">
            Dialogues de gestion, demande de
            <br />
            renforts, organisation des services...
          </p>
        </label>
        <br />
        <mat-icon>arrow_forward</mat-icon>
      </div>
    </div>
  }

  @if (environment.isTJ) {
    <p class="sub-title">Webinaires</p>

    <div class="content-area">
      @for (webinaire of webinaires; track webinaire.title) {
        <div class="webinaire">
          <img class="cover" [src]="webinaire.img" />
          <div class="container">
            <p class="title">{{ webinaire.title }}</p>
            <p class="content">{{ webinaire.content }}</p>
            <div class="action">
              @if (webinaire.action[0] !== null) {
                <div (click)="openLink(webinaire.action[0])">M'inscrire</div>
              }
              @if (webinaire.action[1] !== null) {
                <div (click)="openLink(webinaire.action[1])">En savoir plus</div>
              }
            </div>
          </div>
        </div>
      }
    </div>
  }
}
@if (openSuggestionPanel) {
  <div class="open-panel animate__animated">
    <div class="suggestion-header">
      <div class="back-title">
        <!-- TODO <aj-back-button (click)="openSuggestionPanel = !openSuggestionPanel" /> -->
        <p>Aide</p>
      </div>
      <div class="panel-header">
        @for (doc of documentation; track doc.title) {
          <p
            class="tab {{ doc.color }}"
            [ngClass]="{ selected: openToIframe.url === doc.url }"
            (click)="openToIframe = doc"
          >
            {{ doc.title }}
          </p>
        }
      </div>
    </div>
    @if (openToIframe.url === documentation[0].url) {
      <iframe
        id="iframe-doc"
        loading="lazy"
        [src]="documentation[0].url + cleDate || '' | sanitizeResourceUrl"
      ></iframe>
    }
    @if (openToIframe.url === documentation[1].url) {
      <iframe
        id="iframe-doc"
        loading="lazy"
        [src]="documentation[1].url + cleDate || '' | sanitizeResourceUrl"
      ></iframe>
    }
    @if (openToIframe.url === documentation[2].url) {
      <iframe
        id="iframe-doc"
        loading="lazy"
        [src]="documentation[2].url + cleDate || '' | sanitizeResourceUrl"
      ></iframe>
    }
    @if (openToIframe.url === documentation[3].url) {
      <iframe
        id="iframe-doc"
        loading="lazy"
        [src]="documentation[3].url + cleDate || '' | sanitizeResourceUrl"
      ></iframe>
    }
    <div class="hide-powered-by-gitbook"></div>
  </div>
}

<ng-template #actions></ng-template>
